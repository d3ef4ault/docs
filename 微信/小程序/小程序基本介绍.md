# 小程序基本介绍

## 目录结构

小程序包含一个描述整体程序的 `app` 和多个描述各自页面的 `page`。

一个小程序**主体部分**由三个文件组成，必须放在**项目的根目录**，如下：

| 文件     | 必须 | 作用             |
| -------- | ---- | ---------------- |
| app.js   | 是   | 小程序逻辑       |
| app.json | 是   | 小程序公共配置   |
| app.wxss | 否   | 小程序公共样式表 |

小程序页面由四个文件组成：
| 文件类型 | 必须 | 作用       |
| -------- | ---- | ---------- |
| js       | 是   | 页面逻辑   |
| wxml     | 否   | 页面结构   |
| json     | 是   | 页面配置   |
| wxss     | 否   | 页面样式表 |

## 配置

### 全局配置

`app.json` 文件用来对微信小程序进行全局配置，决定

- 页面文件的路径
- 窗口表现
- 设置网络超时时间
- 设置多 tab 等。

以下为示例：

```json
{
  "pages": [
    "pages/index/index",
    "pages/logs/index"
  ],
  "window": {
    "navigationBarTitleText": "Demo"
  },
  "tabBar": {
    "list": [{
      "pagePath": "pages/index/index",
      "text": "首页"
    }, {
      "pagePath": "pages/logs/logs",
      "text": "日志"
    }]
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  },
  "debug": true
}
```

**`app.json` 配置项列表**

- pages —— 页面路径列表
- window —— 全局的默认窗口表现
- tabBar —— 底部 tab 栏的表现
- networkTimeout —— 网络超时时间
- debug —— 是否开启 debug 模式，默认关闭
- functionalPages —— 是否启用插件功能页，默认关闭
- subPackages —— 分包结构配置
- workers —— `Worker` 代码放置的目录
- requiredBackgroundModes —— 需要在后台使用的能力，如「音乐播放」
- plugins —— 使用到的插件
- preloadRule —— 分包预下载规则
- resizable —— `iPad` 小程序是否支持屏幕旋转，默认关闭

#### pages

用于指定小程序由哪些页面组成，每一项都对应一个页面的 `路径+文件名` 信息。**文件名不需要写文件后缀**，框架会自动去寻找对于位置的 `.json, .js, .wxml, .wxss` 四个文件进行处理。

**数组的第一项代表小程序的初始页面（首页）。小程序中新增/减少页面（除分包页面在 `subPackages` 修改外），都需要对 `pages` 数组进行修改。**

```json
如开发目录为：

├── app.js
├── app.json
├── app.wxss
├── pages
│   │── index
│   │   ├── index.wxml
│   │   ├── index.js
│   │   ├── index.json
│   │   └── index.wxss
│   └── logs
│       ├── log.wxml
│       └── log.js
└── utils

则需要在 app.json 中写

{
  "pages":[
    "pages/index/index",
    "pages/logs/logs"
  ]
}
```

#### window

用于设置小程序的

- 状态栏
- 导航条
- 标题
- 窗口背景色

##### navigationBarBackgroundColor

- 导航栏背景颜色
- 默认值：`#000000`

##### navigationBarTextStyle

- 导航栏标题颜色，仅支持 `black / white`
- 默认值：`white`

##### navigationBarTitleText

- 导航栏标题文字内容

##### navigationStyle

- 导航栏样式，仅支持以下值：
  - `default` 默认样式
  - `custom` 自定义导航栏，只保留右上角胶囊按钮
- 默认值：`default`

##### backgroundColor

- 窗口的背景色
- 默认值：`#ffffff`

##### backgroundTextStyle

- 下拉 `loading` 的样式，仅支持 `dark / light`
- 默认值：`dark`

##### backgroundColorTop

- 顶部窗口的背景色，**仅 iOS 支持**
- 默认值：`#ffffff`

##### backgroundColorBottom

- 底部窗口的背景色，**仅 iOS 支持**
- 默认值：`#ffffff`

##### enablePullDownRefresh

- 是否全局开启下拉刷新。
- 默认值：`false`

##### onReachBottomDistance

- 页面上拉触底事件触发时距页面底部距离，单位为px
- 默认值：`50`

**注：`navigationStyle` 只在 `app.json` 中生效。开启 `custom` 后，低版本客户端需要做好兼容。开发者工具基础库版本切到 1.7.0（不代表最低版本，只供调试用）可方便切到旧视觉**

示例：

```json
{
  "window":{
    "navigationBarBackgroundColor": "#ffffff",
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "微信接口功能演示",
    "backgroundColor": "#eeeeee",
    "backgroundTextStyle": "light"
  }
}
```

#### tabBar

如果小程序是一个多 tab 应用（客户端窗口的底部或顶部有 tab 栏可以切换页面），可以通过 tabBar 配置项指定 tab 栏的表现，以及 tab 切换时显示的对应页面。

##### color 【必填】

- tab 上的文字默认颜色

##### selectedColor 【必填】

- tab 上的文字选中时的颜色

##### backgroundColor 【必填】

- tab 的背景色

##### borderStyle 【必填】

- tab tabbar上边框的颜色， 仅支持 `black / white`
- 默认值：`black`

##### list 【必填】

- tab 的列表，接受一个数组，只能配置最少2个、最多5个 tab
- tab 按数组的顺序排序，每个项都是一个对象，其属性值如下：
  - pagePath 【必填】
    - 页面路径，必须在 pages 中先定义
  - text 【必填】
    - tab 上按钮文字
  - iconPath
    - 图片路径，**icon 大小限制为40kb**，建议尺寸为 `81px * 81px`，**不支持网络图片**
    - **当 postion 为 top 时，不显示 icon**
  - selectedIconPath
    - 选中时的图片路径，**icon 大小限制为40kb**，建议尺寸为 `81px * 81px`，**不支持网络图片**
    - **当 postion 为 top 时，不显示 icon**

##### position 【必填】

- tabBar的位置，仅支持 `bottom / top`
- 默认值：`bottom`

#### networkTimeout

各类网络请求的超时时间，单位均为毫秒。

##### request

- `wx.request` 的超时时间
- 单位: 毫秒
- 默认值：`60000`

##### connectSocket

- `wx.connectSocket` 的超时时间
- 单位: 毫秒
- 默认值：`60000`

##### uploadFile

- `wx.uploadFile` 的超时时间
- 单位: 毫秒
- 默认值：`60000`

##### downloadFile

- `wx.downloadFile` 的超时时间
- 单位: 毫秒
- 默认值：`60000`

#### debug

可以在开发者工具中开启 debug 模式，在开发者工具的控制台面板，调试信息以 info 的形式给出，其信息有Page的注册，页面路由，数据更新，事件触发等。可以帮助开发者快速定位一些常见的问题。

#### functionalPages

启用插件功能页时，插件所有者小程序需要设置其 `functionalPages` 为 `true`

#### subPackages

启用**分包加载**时，声明项目分包结构

#### workers

使用 Worker 处理多线程任务时，设置 Worker 代码放置的目录

#### requiredBackgroundModes

申明需要后台运行的能力，类型为数组。目前支持以下项目：

##### `audio` 后台音乐播放

示例：

```json
{
  "pages": ["pages/index/index"],
  "requiredBackgroundModes": ["audio"]
}
```

**注：在此处申明了后台运行的接口，开发版和体验版上可以直接生效，正式版还需通过审核。**

#### plugins

声明小程序需要使用的插件

#### preloadRule

声明分包预下载的规则

#### resizable

在 iPad 上运行的小程序可以设置支持屏幕旋转

### 页面配置

每一个小程序页面也可以使用`.json`文件来对本页面的窗口表现进行配置

**页面的配置只能设置 `app.json` 中部分 `window` 配置项的内容，页面中配置项会覆盖 `app.json` 的 `window` 中相同的配置项**

- navigationBarBackgroundColor
  - 导航栏背景颜色
  - 默认值：`#000000`
- navigationBarTextStyle
  - 导航栏标题颜色，仅支持 `black / white`
  - 默认值：`white`
- navigationBarTitleText
  - 导航栏标题文字内容
- backgroundColor
  - 窗口的背景色
  - 默认值： `#ffffff`
- backgroundTextStyle
  - 下拉 loading 的样式，仅支持 `dark / light`
  - 默认值：`dark`
- enablePullDownRefresh
  - 是否全局开启下拉刷新
  - 默认值：`false`
- onReachBottomDistance
  - 页面上拉触底事件触发时距页面底部距离
  - 单位：`px`
  - 默认值：`50`
- disableScroll
  - 设置为 true 则页面整体不能上下滚动
  - **只在页面配置中有效，无法在 app.json 中设置该项**
  - 默认值：`false`

示例：

```json
{
  "navigationBarBackgroundColor": "#ffffff",
  "navigationBarTextStyle": "black",
  "navigationBarTitleText": "微信接口功能演示",
  "backgroundColor": "#eeeeee",
  "backgroundTextStyle": "light"
}
```

**页面的`.json`只能设置 `window` 相关的配置项，以决定本页面的窗口表现，所以无需写 `window` 这个键**

## 逻辑层 App Service

小程序开发框架的逻辑层使用 `JavaScript` 引擎为小程序提供开发者 `JavaScript` 代码的运行环境以及微信小程序的特有功能。

逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈

开发者写的所有代码最终将会打包成一份 `JavaScrip`t 文件，并在小程序启动的时候运行，直到小程序销毁。这一行为类似 `ServiceWorker`，所以逻辑层也称之为 `App Service`

在 `JavaScript` 的基础上，小程序增加了一些功能，以方便开发：

- 增加 `App` 和 `Page` 方法，进行程序和页面的注册
- 增加 `getApp` 和 `getCurrentPages` 方法，分别用来获取 **App 实例**和**当前页面栈**
- 提供丰富的 API，如微信用户数据，扫一扫，支付等微信特有能力
- 每个页面有独立的作用域，并提供模块化能力

**注意：`小程序框架的逻辑层并非运行在浏览器中`，因此 JavaScript 在 web 中一些能力都无法使用，如 `window，document` 等**

### 注册页面 (小程序 App)

#### App(Object)

`App()` 函数用来注册一个小程序。接受一个 Object 参数，其指定小程序的生命周期回调等

**`App()` 必须在 `app.js` 中调用，必须调用且只能调用一次。不然会出现无法预期的后果。**

示例：

```javascript
App({
  onLaunch: function(options) {
    // Do something initial when launch.
  },
  onShow: function(options) {
    // Do something when show.
  },
  onHide: function() {
    // Do something when hide.
  },
  onError: function(msg) {
    console.log(msg)
  },
  globalData: 'I am global data'
})
```

##### onLaunch(Object)

生命周期回调—监听小程序初始化，小程序初始化完成时（全局只触发一次）

**Object 参数说明**

- `path` 打开小程序的路径
- `query` 打开小程序的 `query`
- `scene` d打开小程序的场景值
- `shareTicket` 获取到转发信息
- `referrerInfo` 当场景为由从另一个小程序或公众号或App打开时，返回此字段
- `referrerInfo.appId` 来源小程序或公众号或App的 appId (根据场景值不同，有不同的来源)
- `referrerInfo.extraData` 来源小程序传过来的数据，`scene=1037`(小程序打开小程序)或`scenc=1038`(从另一个小程序返回)时支持

##### onShow(Object)

小程序启动，或从后台进入前台显示时触发

**Object 参数说明 同`onLaunch`**

##### onHide()

小程序从前台进入后台时触发

##### onError(String error)

小程序发生脚本错误，或者 api 调用失败时触发。

**参数说明**

- `error` 错误信息，包含堆栈

##### onPageNotFound(Object)

小程序要打开的页面不存在时触发

**Object 参数说明**

- `path` 不存在的页面路径
- `query` 打开不存在页面的 `query`
- `isEntryPage` 是否本次启动的首个页面（例如从分享等入口进来，首个页面是开发者配置的分享页面）

**可以在 `onPageNotFound` 回调中进行重定向处理，但必须在回调中同步处理，异步处理（例如 `setTimeout` 异步执行）无效**

示例：

```javascript
App({
  onPageNotFound(res) {
    wx.redirectTo({
      url: 'pages/...'
    }) // 如果是 tabbar 页面，请使用 wx.switchTab
  }
})
```

**注意：**

- 如果开发者没有添加 `onPageNotFound` 监听，当跳转页面不存在时，将推入微信客户端原生的页面不存在提示页面。
- 如果 `onPageNotFound` 回调中又重定向到另一个不存在的页面，将推入微信客户端原生的页面不存在提示页面，并且不再回调 `onPageNotFound`

##### getApp(Object)

全局的 `getApp()` 函数可以用来获取到小程序 `App` 实例

**Object 参数说明**

- `allowDefault` 在 `App` 未定义时返回默认实现。当App被调用时，默认实现中定义的属性会被覆盖合并到App中。一般用于独立分包

```javascript
// other.js
var appInstance = getApp()
console.log(appInstance.globalData) // I am global data
```

**注意：**

- 不要在定义于 ·App()· 内的函数中调用 getApp() ，使用 this 就可以拿到 app 实例